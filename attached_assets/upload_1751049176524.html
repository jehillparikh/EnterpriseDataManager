<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Data Upload - Mutual Fund API</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <style>
        .upload-section {
            border: 2px dashed var(--bs-border-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            transition: border-color 0.3s ease;
        }
        .upload-section:hover {
            border-color: var(--bs-primary);
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            margin-top: 1rem;
        }
        .progress {
            display: none;
            margin-top: 1rem;
        }
        .result {
            margin-top: 1rem;
            display: none;
        }
        .file-info {
            margin-top: 1rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Fund Data Upload</h1>
                <p class="lead">Upload Excel files to import mutual fund data into the database.</p>
            </div>
        </div>

        <!-- Factsheet Upload -->
        <div class="row">
            <div class="col-12">
                <div class="upload-section" id="factsheet-section">
                    <h3>Factsheet Data</h3>
                    <p>Upload Excel file containing fund basic information and factsheet data.</p>
                    <input type="file" id="factsheet-file" class="file-input" accept=".xlsx,.xls">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('factsheet-file').click()">
                        Choose Factsheet File
                    </button>
                    <div class="file-info" id="factsheet-info"></div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="factsheet-clear">
                        <label class="form-check-label" for="factsheet-clear">
                            Clear existing factsheet data before import
                        </label>
                    </div>
                    <button class="btn btn-primary upload-btn" id="factsheet-upload" disabled onclick="uploadFile('factsheet')">
                        Upload Factsheet Data
                    </button>
                    <div class="progress" id="factsheet-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <div class="result" id="factsheet-result"></div>
                </div>
            </div>
        </div>

        <!-- Returns Upload -->
        <div class="row">
            <div class="col-12">
                <div class="upload-section" id="returns-section">
                    <h3>Returns Data</h3>
                    <p>Upload Excel file containing fund performance and returns data.</p>
                    <input type="file" id="returns-file" class="file-input" accept=".xlsx,.xls">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('returns-file').click()">
                        Choose Returns File
                    </button>
                    <div class="file-info" id="returns-info"></div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="returns-clear">
                        <label class="form-check-label" for="returns-clear">
                            Clear existing returns data before import
                        </label>
                    </div>
                    <button class="btn btn-primary upload-btn" id="returns-upload" disabled onclick="uploadFile('returns')">
                        Upload Returns Data
                    </button>
                    <div class="progress" id="returns-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <div class="result" id="returns-result"></div>
                </div>
            </div>
        </div>

        <!-- Portfolio Upload -->
        <div class="row">
            <div class="col-12">
                <div class="upload-section" id="portfolio-section">
                    <h3>Portfolio Holdings Data</h3>
                    <p>Upload Excel file containing fund portfolio holdings and asset allocation data.</p>
                    <input type="file" id="portfolio-file" class="file-input" accept=".xlsx,.xls">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('portfolio-file').click()">
                        Choose Portfolio File
                    </button>
                    <div class="file-info" id="portfolio-info"></div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="portfolio-clear">
                        <label class="form-check-label" for="portfolio-clear">
                            Clear existing portfolio data before import
                        </label>
                    </div>
                    <button class="btn btn-primary upload-btn" id="portfolio-upload" disabled onclick="uploadFile('portfolio')">
                        Upload Portfolio Data
                    </button>
                    <div class="progress" id="portfolio-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <div class="result" id="portfolio-result"></div>
                </div>
            </div>
        </div>

        <!-- NAV Upload -->
        <div class="row">
            <div class="col-12">
                <div class="upload-section" id="nav-section">
                    <h3>NAV History Data</h3>
                    <p>Upload Excel file containing NAV history and time series data.</p>
                    <input type="file" id="nav-file" class="file-input" accept=".xlsx,.xls">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('nav-file').click()">
                        Choose NAV File
                    </button>
                    <div class="file-info" id="nav-info"></div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="nav-clear">
                        <label class="form-check-label" for="nav-clear">
                            Clear existing NAV data before import
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="nav-batch-size" class="form-label">Batch Size (for large files)</label>
                        <input type="number" class="form-control" id="nav-batch-size" value="1000" min="100" max="10000">
                    </div>
                    <button class="btn btn-primary upload-btn" id="nav-upload" disabled onclick="uploadFile('nav')">
                        Upload NAV Data
                    </button>
                    <div class="progress" id="nav-progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                    <div class="result" id="nav-result"></div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>Upload Instructions:</h5>
                    <ul class="mb-0">
                        <li>Upload files in order: Factsheet → Returns → Portfolio → NAV</li>
                        <li>Factsheet data must be uploaded first as it creates the base fund records</li>
                        <li>Only Excel files (.xlsx, .xls) are supported</li>
                        <li>Files are temporarily stored and automatically deleted after processing</li>
                        <li>Large NAV files may take several minutes to process</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File input change handlers
        document.getElementById('factsheet-file').addEventListener('change', function(e) {
            handleFileSelect(e, 'factsheet');
        });

        document.getElementById('returns-file').addEventListener('change', function(e) {
            handleFileSelect(e, 'returns');
        });

        document.getElementById('portfolio-file').addEventListener('change', function(e) {
            handleFileSelect(e, 'portfolio');
        });

        document.getElementById('nav-file').addEventListener('change', function(e) {
            handleFileSelect(e, 'nav');
        });

        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            const infoDiv = document.getElementById(type + '-info');
            const uploadBtn = document.getElementById(type + '-upload');

            if (file) {
                infoDiv.innerHTML = `
                    <div class="alert alert-secondary">
                        <strong>Selected:</strong> ${file.name}<br>
                        <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                    </div>
                `;
                infoDiv.style.display = 'block';
                uploadBtn.disabled = false;
            } else {
                infoDiv.style.display = 'none';
                uploadBtn.disabled = true;
            }
        }

        function uploadFile(type) {
            const fileInput = document.getElementById(type + '-file');
            const clearCheckbox = document.getElementById(type + '-clear');
            const progressDiv = document.getElementById(type + '-progress');
            const resultDiv = document.getElementById(type + '-result');
            const uploadBtn = document.getElementById(type + '-upload');

            if (!fileInput.files[0]) {
                alert('Please select a file first');
                return;
            }

            // Show progress bar and disable button
            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            uploadBtn.disabled = true;

            // Create FormData
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('clear_existing', clearCheckbox.checked);

            // Add batch size for NAV uploads
            if (type === 'nav') {
                const batchSize = document.getElementById('nav-batch-size').value;
                formData.append('batch_size', batchSize);
            }

            // Make API call
            fetch(`/api/upload/${type}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                uploadBtn.disabled = false;

                if (data.error) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${data.error}
                        </div>
                    `;
                } else {
                    let statsHtml = '';
                    if (data.stats) {
                        statsHtml = '<ul class="mb-0">';
                        for (const [key, value] of Object.entries(data.stats)) {
                            statsHtml += `<li>${key.replace(/_/g, ' ')}: ${value}</li>`;
                        }
                        statsHtml += '</ul>';
                    }

                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success:</strong> ${data.message}
                            ${statsHtml ? '<br><strong>Statistics:</strong>' + statsHtml : ''}
                        </div>
                    `;
                }
            })
            .catch(error => {
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                uploadBtn.disabled = false;

                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message || 'Upload failed'}
                    </div>
                `;
            });
        }
    </script>
</body>
</html>